<!-- ============================================================
     ASK AI GIO — Chat Widget v2 (with Animated Avatar)
     Drop this into your index.html before </body>
     
     REQUIRES: Vercel API proxy deployed at your domain
     API routes: /api/chat (Claude) and /api/tts (ElevenLabs)
     ============================================================ -->

<style>
/* ============================================================
   ASK AI GIO — Widget Styles v2
   Inherits CSS variables from the main site
   ============================================================ */

/* --- Floating Trigger Button --- */
#gio-chat-trigger {
  position: fixed;
  bottom: 28px;
  left: 28px;
  z-index: 9990;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 20px 12px 14px;
  background: var(--surface, #fff);
  border: 1px solid var(--border, #e8e8e8);
  border-radius: 40px;
  cursor: pointer;
  box-shadow: var(--card-shadow, 0 2px 12px rgba(0,0,0,.06));
  transition: all .3s var(--ease);
  font-family: var(--font-body);
}
#gio-chat-trigger:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 12px 48px rgba(255,107,43,.2);
}
#gio-chat-trigger .gio-trigger-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--accent);
}
#gio-chat-trigger .gio-trigger-text {
  display: flex;
  flex-direction: column;
}
#gio-chat-trigger .gio-trigger-label {
  font-family: var(--font-display);
  font-weight: 700;
  font-size: .85rem;
  color: var(--text);
  line-height: 1.2;
}
#gio-chat-trigger .gio-trigger-sub {
  font-family: var(--font-mono);
  font-size: .6rem;
  color: var(--accent);
  letter-spacing: 1.5px;
  text-transform: uppercase;
}
#gio-chat-trigger .gio-trigger-pulse {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #22c55e;
  animation: gio-pulse 2s infinite;
  flex-shrink: 0;
}
@keyframes gio-pulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34,197,94,.4); }
  50% { opacity: .7; box-shadow: 0 0 0 6px rgba(34,197,94,0); }
}

/* --- Chat Window --- */
#gio-chat-window {
  position: fixed;
  bottom: 90px;
  left: 28px;
  z-index: 9991;
  width: 400px;
  max-width: calc(100vw - 40px);
  height: 580px;
  max-height: calc(100vh - 120px);
  background: var(--bg2, #fff);
  border: 1px solid var(--border, #e8e8e8);
  border-radius: var(--radius);
  box-shadow: 0 8px 40px rgba(0,0,0,.15);
  display: none;
  flex-direction: column;
  overflow: hidden;
  opacity: 0;
  transform: translateY(16px) scale(.96);
  transition: opacity .3s var(--ease), transform .3s var(--ease);
  font-family: var(--font-body);
}
#gio-chat-window.gio-open { display: flex; }
#gio-chat-window.gio-visible { opacity: 1; transform: translateY(0) scale(1); }

/* --- Header --- */
.gio-chat-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 18px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  flex-shrink: 0;
}
.gio-chat-header .gio-h-info { flex: 1; }
.gio-chat-header .gio-h-name {
  font-family: var(--font-display);
  font-weight: 700;
  font-size: .95rem;
  color: var(--text);
}
.gio-chat-header .gio-h-status {
  font-size: .72rem;
  color: var(--text3);
  display: flex;
  align-items: center;
  gap: 5px;
}
.gio-chat-header .gio-h-status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #22c55e;
}
.gio-chat-header .gio-h-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text3);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: .85rem;
  transition: all .2s;
}
.gio-chat-header .gio-h-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.gio-chat-header .gio-h-btn.gio-sound-active {
  border-color: var(--accent);
  background: var(--accent-glow);
  color: var(--accent);
}

/* ============================================================
   ANIMATED AVATAR
   ============================================================ */
.gio-avatar-wrap {
  position: relative;
  width: 44px;
  height: 44px;
  flex-shrink: 0;
}

/* The canvas ring sits behind the photo */
.gio-avatar-canvas {
  position: absolute;
  inset: -6px;
  width: calc(100% + 12px);
  height: calc(100% + 12px);
  z-index: 0;
  pointer-events: none;
}

/* Photo itself */
.gio-avatar-img {
  position: relative;
  z-index: 1;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  object-fit: cover;
  transition: filter .4s var(--ease), transform .4s var(--ease);
}

/* Mode-aware avatar swap */
body[data-mode="perso"] .gio-avatar-img.gio-av-pro { display: none; }
body[data-mode="pro"] .gio-avatar-img.gio-av-perso { display: none; }
body[data-mode="perso"] .gio-avatar-img.gio-av-perso { display: block; }
body[data-mode="pro"] .gio-avatar-img.gio-av-pro { display: block; }

/* State: Idle — subtle float */
.gio-avatar-wrap[data-state="idle"] .gio-avatar-img {
  animation: gio-av-float 3s ease-in-out infinite;
}
@keyframes gio-av-float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-2px); }
}

/* State: Thinking — desaturate + pulse */
.gio-avatar-wrap[data-state="thinking"] .gio-avatar-img {
  filter: saturate(.5) brightness(.9);
  animation: gio-av-think 1s ease-in-out infinite;
}
@keyframes gio-av-think {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(.96); }
}

/* State: Speaking — brightness lift + micro-pulse */
.gio-avatar-wrap[data-state="speaking"] .gio-avatar-img {
  filter: brightness(1.08);
  animation: gio-av-speak .6s ease-in-out infinite alternate;
}
@keyframes gio-av-speak {
  from { transform: scale(1); }
  to { transform: scale(1.03); }
}

/* --- Welcome Avatar (larger version) --- */
.gio-welcome-av-wrap {
  position: relative;
  width: 88px;
  height: 88px;
}
.gio-welcome-av-canvas {
  position: absolute;
  inset: -10px;
  width: calc(100% + 20px);
  height: calc(100% + 20px);
  z-index: 0;
  pointer-events: none;
}
.gio-welcome-av-img {
  position: relative;
  z-index: 1;
  width: 88px;
  height: 88px;
  border-radius: 50%;
  object-fit: cover;
  animation: gio-av-float 3s ease-in-out infinite;
}
body[data-mode="perso"] .gio-welcome-av-img.gio-av-pro { display: none; }
body[data-mode="pro"] .gio-welcome-av-img.gio-av-perso { display: none; }
body[data-mode="perso"] .gio-welcome-av-img.gio-av-perso { display: block; }
body[data-mode="pro"] .gio-welcome-av-img.gio-av-pro { display: block; }

/* --- Messages --- */
.gio-chat-msgs {
  flex: 1;
  overflow-y: auto;
  padding: 18px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--surface2);
}
.gio-chat-msgs::-webkit-scrollbar { width: 4px; }
.gio-chat-msgs::-webkit-scrollbar-track { background: transparent; }
.gio-chat-msgs::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 2px; }

.gio-msg {
  max-width: 85%;
  display: flex;
  flex-direction: column;
  gap: 4px;
  animation: gio-msg-in .3s var(--ease);
}
@keyframes gio-msg-in {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.gio-msg-user { align-self: flex-end; }
.gio-msg-ai { align-self: flex-start; }
.gio-msg .gio-bubble {
  padding: 12px 16px;
  border-radius: 16px;
  font-size: .88rem;
  line-height: 1.6;
  word-break: break-word;
}
.gio-msg-user .gio-bubble {
  background: var(--accent);
  color: #fff;
  border-bottom-right-radius: 4px;
}
.gio-msg-ai .gio-bubble {
  background: var(--surface2);
  color: var(--text);
  border-bottom-left-radius: 4px;
}
.gio-msg .gio-meta {
  font-size: .65rem;
  color: var(--text3);
  font-family: var(--font-mono);
  letter-spacing: .5px;
  padding: 0 4px;
}
.gio-msg-user .gio-meta { text-align: right; }

/* --- Typing Indicator --- */
.gio-typing {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 14px 18px;
  background: var(--surface2);
  border-radius: 16px;
  border-bottom-left-radius: 4px;
  max-width: 70px;
  align-self: flex-start;
}
.gio-typing span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text3);
  animation: gio-bounce .6s infinite alternate;
}
.gio-typing span:nth-child(2) { animation-delay: .15s; }
.gio-typing span:nth-child(3) { animation-delay: .3s; }
@keyframes gio-bounce {
  from { transform: translateY(0); opacity: .4; }
  to { transform: translateY(-4px); opacity: 1; }
}

/* --- Disclaimer --- */
.gio-disclaimer {
  padding: 6px 18px;
  font-size: .62rem;
  color: var(--text3);
  text-align: center;
  font-family: var(--font-mono);
  letter-spacing: .5px;
  border-top: 1px solid var(--border);
  background: var(--surface);
  flex-shrink: 0;
  line-height: 1.4;
}
.gio-disclaimer .gio-badge {
  display: inline-block;
  background: var(--accent-glow);
  border: 1px solid var(--accent-border);
  color: var(--accent);
  font-weight: 700;
  padding: 1px 6px;
  border-radius: 4px;
  font-size: .58rem;
  margin-right: 4px;
}

/* --- Suggestions --- */
.gio-suggestions {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 0 18px 10px;
  flex-shrink: 0;
}
.gio-chip {
  font-family: var(--font-body);
  font-size: .75rem;
  padding: 7px 14px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text2);
  cursor: pointer;
  transition: all .2s;
  white-space: nowrap;
}
.gio-chip:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: var(--accent-glow);
}

/* --- Welcome Screen --- */
.gio-welcome {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 32px;
  text-align: center;
  gap: 16px;
}
.gio-welcome h3 {
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 1.3rem;
  color: var(--text);
  letter-spacing: -.5px;
}
.gio-welcome h3 span { color: var(--accent); }
.gio-welcome p {
  font-size: .85rem;
  color: var(--text2);
  line-height: 1.6;
  max-width: 300px;
}

/* --- Input Area --- */
.gio-input-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 14px;
  border-top: 1px solid var(--border);
  background: var(--surface);
  flex-shrink: 0;
}
.gio-input-wrap input {
  flex: 1;
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 10px 16px;
  font-family: var(--font-body);
  font-size: .85rem;
  background: var(--bg2, #fff);
  color: var(--text);
  outline: none;
  transition: border-color .2s;
}
.gio-input-wrap input::placeholder { color: var(--text3); }
.gio-input-wrap input:focus { border-color: var(--accent); }
.gio-send {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: none;
  background: var(--accent);
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .2s;
  flex-shrink: 0;
}
.gio-send:hover { background: var(--accent2); transform: scale(1.05); }
.gio-send:disabled { opacity: .4; cursor: not-allowed; transform: none; }
.gio-send svg {
  width: 16px;
  height: 16px;
  fill: none;
  stroke: #fff;
  stroke-width: 2.5;
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* --- Mobile --- */
@media (max-width: 500px) {
  #gio-chat-trigger {
    bottom: 16px;
    left: 16px;
    padding: 10px 16px 10px 12px;
  }
  #gio-chat-trigger .gio-trigger-text { display: none; }
  #gio-chat-window {
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    max-width: 100%;
    height: 100vh;
    max-height: 100vh;
    height: 100dvh;
    max-height: 100dvh;
    border-radius: 0;
  }
}
</style>

<!-- Trigger Button -->
<div id="gio-chat-trigger" onclick="GioChat.toggle()">
  <img class="gio-trigger-avatar" src="./images/blazer-cutout.png" alt="Gio"
       onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 40 40%27%3E%3Ccircle cx=%2720%27 cy=%2720%27 r=%2720%27 fill=%27%23FF6B2B%27/%3E%3Ctext x=%2720%27 y=%2726%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27700%27 font-size=%2718%27 fill=%27white%27%3EG%3C/text%3E%3C/svg%3E'">
  <div class="gio-trigger-text">
    <span class="gio-trigger-label">Ask AI Gio</span>
    <span class="gio-trigger-sub">AI Prototype</span>
  </div>
  <div class="gio-trigger-pulse"></div>
</div>

<!-- Chat Window -->
<div id="gio-chat-window">
  <!-- Header with Animated Avatar -->
  <div class="gio-chat-header">
    <div class="gio-avatar-wrap" id="gio-avatar-wrap" data-state="idle">
      <canvas class="gio-avatar-canvas" id="gio-avatar-canvas"></canvas>
      <img class="gio-avatar-img gio-av-pro" src="./images/blazer-cutout.png" alt="Gio"
           onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 44 44%27%3E%3Ccircle cx=%2722%27 cy=%2722%27 r=%2722%27 fill=%27%23FF6B2B%27/%3E%3Ctext x=%2722%27 y=%2730%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27700%27 font-size=%2720%27 fill=%27white%27%3EG%3C/text%3E%3C/svg%3E'">
      <img class="gio-avatar-img gio-av-perso" src="./images/NFT/Solana%20Monkey%20Business.jpeg" alt="AI Gio"
           onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 44 44%27%3E%3Ccircle cx=%2722%27 cy=%2722%27 r=%2722%27 fill=%27%239333ea%27/%3E%3Ctext x=%2722%27 y=%2730%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27700%27 font-size=%2720%27 fill=%27white%27%3EG%3C/text%3E%3C/svg%3E'">
    </div>
    <div class="gio-h-info">
      <div class="gio-h-name">AI Gio</div>
      <div class="gio-h-status">
        <span class="gio-h-status-dot"></span>
        <span id="gio-status">Online</span>
      </div>
    </div>
    <button class="gio-h-btn" id="gio-sound-btn" onclick="GioChat.toggleSound()" title="Toggle voice">&#x1f50a;</button>
    <button class="gio-h-btn" onclick="GioChat.toggle()" title="Close">&#x2715;</button>
  </div>

  <!-- Welcome Screen with Animated Avatar -->
  <div class="gio-welcome" id="gio-welcome">
    <div class="gio-welcome-av-wrap">
      <canvas class="gio-welcome-av-canvas" id="gio-welcome-canvas"></canvas>
      <img class="gio-welcome-av-img gio-av-pro" src="./images/blazer-cutout.png" alt="Gio"
           onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 88 88%27%3E%3Ccircle cx=%2744%27 cy=%2744%27 r=%2744%27 fill=%27%23FF6B2B%27/%3E%3Ctext x=%2744%27 y=%2758%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27700%27 font-size=%2740%27 fill=%27white%27%3EG%3C/text%3E%3C/svg%3E'">
      <img class="gio-welcome-av-img gio-av-perso" src="./images/NFT/Solana%20Monkey%20Business.jpeg" alt="AI Gio"
           onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 88 88%27%3E%3Ccircle cx=%2744%27 cy=%2744%27 r=%2744%27 fill=%27%239333ea%27/%3E%3Ctext x=%2744%27 y=%2758%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27700%27 font-size=%2740%27 fill=%27white%27%3EG%3C/text%3E%3C/svg%3E'">
    </div>
    <h3>Ask AI <span>Gio</span></h3>
    <p>An AI prototype trained on Gio's public persona, writings, and talks. Ask me anything about banking innovation, Web3, or what it's like being a closeted DeFi maxi in a banker's suit.</p>
  </div>

  <!-- Messages -->
  <div class="gio-chat-msgs" id="gio-msgs" style="display:none;"></div>

  <!-- Suggestions -->
  <div class="gio-suggestions" id="gio-suggestions">
    <button class="gio-chip" onclick="GioChat.askChip(this)">What is CBIx?</button>
    <button class="gio-chip" onclick="GioChat.askChip(this)">Your view on tokenized assets?</button>
    <button class="gio-chip" onclick="GioChat.askChip(this)">What NFTs do you collect?</button>
    <button class="gio-chip" onclick="GioChat.askChip(this)">Book Gio for a keynote</button>
  </div>

  <!-- Disclaimer -->
  <div class="gio-disclaimer">
    <span class="gio-badge">AI PROTOTYPE</span>
    This is not the real Gio. Responses are AI-generated and may not be accurate.
  </div>

  <!-- Input -->
  <div class="gio-input-wrap">
    <input id="gio-input" type="text" placeholder="Ask AI Gio something..."
           onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();GioChat.send()}"
           autocomplete="off">
    <button class="gio-send" id="gio-send" onclick="GioChat.send()">
      <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
    </button>
  </div>
</div>


<script>
// ============================================================
// ASK AI GIO — Core Logic v2 with Animated Avatar
// ============================================================
var GioChat = (function() {
  'use strict';

  var API_BASE = '';
  var SOUND_ON = true;
  var messages = [];
  var processing = false;
  var started = false;
  var audio = null;
  var audioCtx = null;
  var analyser = null;
  var audioSource = null;
  var freqData = null;

  function $(id) { return document.getElementById(id); }
  function escHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

  // ============================================================
  // AVATAR RING RENDERER
  // Draws a glowing ring around the avatar on a canvas
  // Ring style changes based on state: idle, thinking, speaking
  // ============================================================
  var AvatarRing = (function() {
    var headerCanvas, headerCtx, welcomeCanvas, welcomeCtx;
    var animFrame = null;
    var state = 'idle'; // idle | thinking | speaking
    var tick = 0;

    function init() {
      headerCanvas = $('gio-avatar-canvas');
      welcomeCanvas = $('gio-welcome-canvas');
      if (headerCanvas) {
        setupCanvas(headerCanvas, 56, 56); // 44 + 12 padding
        headerCtx = headerCanvas.getContext('2d');
      }
      if (welcomeCanvas) {
        setupCanvas(welcomeCanvas, 108, 108); // 88 + 20 padding
        welcomeCtx = welcomeCanvas.getContext('2d');
      }
      loop();
    }

    function setupCanvas(c, w, h) {
      var dpr = window.devicePixelRatio || 1;
      c.width = w * dpr;
      c.height = h * dpr;
      c.style.width = w + 'px';
      c.style.height = h + 'px';
      var ctx = c.getContext('2d');
      ctx.scale(dpr, dpr);
    }

    function isDark() {
      return document.body.dataset.mode === 'perso';
    }

    // Get accent color based on mode
    function getColor() {
      return isDark() ? { r: 147, g: 51, b: 234 } : { r: 255, g: 107, b: 43 }; // purple vs orange
    }

    // Get average audio level from analyser (0-1)
    function getAudioLevel() {
      if (!analyser || !freqData) return 0;
      analyser.getByteFrequencyData(freqData);
      var sum = 0;
      for (var i = 0; i < freqData.length; i++) sum += freqData[i];
      return Math.min(1, (sum / freqData.length) / 128);
    }

    function drawRing(ctx, cx, cy, radius, lineWidth) {
      var col = getColor();
      tick++;

      if (state === 'idle') {
        // Soft pulsing glow ring
        var pulse = 0.3 + Math.sin(tick * 0.03) * 0.15;
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(' + col.r + ',' + col.g + ',' + col.b + ',' + pulse + ')';
        ctx.lineWidth = lineWidth;
        ctx.stroke();

        // Outer glow
        ctx.beginPath();
        ctx.arc(cx, cy, radius + 2, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(' + col.r + ',' + col.g + ',' + col.b + ',' + (pulse * 0.3) + ')';
        ctx.lineWidth = lineWidth * 2;
        ctx.stroke();

      } else if (state === 'thinking') {
        // Rotating gradient sweep
        var angle = (tick * 0.04) % (Math.PI * 2);
        var segments = 32;
        for (var i = 0; i < segments; i++) {
          var a1 = (i / segments) * Math.PI * 2;
          var a2 = ((i + 1) / segments) * Math.PI * 2;
          // Distance from sweep head
          var dist = ((a1 - angle + Math.PI * 4) % (Math.PI * 2)) / (Math.PI * 2);
          var alpha = Math.pow(1 - dist, 3) * 0.8;
          ctx.beginPath();
          ctx.arc(cx, cy, radius, a1, a2);
          ctx.strokeStyle = 'rgba(' + col.r + ',' + col.g + ',' + col.b + ',' + alpha + ')';
          ctx.lineWidth = lineWidth;
          ctx.stroke();
        }

        // Pulsing inner ring
        var ip = 0.15 + Math.sin(tick * 0.06) * 0.1;
        ctx.beginPath();
        ctx.arc(cx, cy, radius - 2, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(' + col.r + ',' + col.g + ',' + col.b + ',' + ip + ')';
        ctx.lineWidth = 1;
        ctx.stroke();

      } else if (state === 'speaking') {
        // Audio-reactive waveform ring
        var level = getAudioLevel();
        var numBars = 48;
        var baseRadius = radius - 2;

        // Background glow proportional to volume
        var glowAlpha = 0.1 + level * 0.25;
        ctx.beginPath();
        ctx.arc(cx, cy, radius + 3, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(' + col.r + ',' + col.g + ',' + col.b + ',' + glowAlpha + ')';
        ctx.lineWidth = lineWidth * 3;
        ctx.stroke();

        // Draw individual bars radiating outward
        for (var j = 0; j < numBars; j++) {
          var barAngle = (j / numBars) * Math.PI * 2;

          // Get frequency band for this bar
          var barLevel = 0;
          if (analyser && freqData) {
            var freqIndex = Math.floor((j / numBars) * freqData.length);
            barLevel = freqData[freqIndex] / 255;
          } else {
            // Fallback: simulate with sine waves
            barLevel = 0.3 + Math.sin(tick * 0.08 + j * 0.4) * 0.3 + Math.sin(tick * 0.12 + j * 0.7) * 0.2;
          }

          var barHeight = 2 + barLevel * lineWidth * 3;
          var x1 = cx + Math.cos(barAngle) * baseRadius;
          var y1 = cy + Math.sin(barAngle) * baseRadius;
          var x2 = cx + Math.cos(barAngle) * (baseRadius + barHeight);
          var y2 = cy + Math.sin(barAngle) * (baseRadius + barHeight);

          var barAlpha = 0.4 + barLevel * 0.6;
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.strokeStyle = 'rgba(' + col.r + ',' + col.g + ',' + col.b + ',' + barAlpha + ')';
          ctx.lineWidth = 1.5;
          ctx.lineCap = 'round';
          ctx.stroke();
        }
      }
    }

    function loop() {
      // Draw header avatar ring
      if (headerCtx && headerCanvas) {
        var hw = headerCanvas.width / (window.devicePixelRatio || 1);
        var hh = headerCanvas.height / (window.devicePixelRatio || 1);
        headerCtx.clearRect(0, 0, hw, hh);
        drawRing(headerCtx, hw / 2, hh / 2, 20, 2);
      }

      // Draw welcome avatar ring (only if visible)
      var welcomeEl = $('gio-welcome');
      if (welcomeCtx && welcomeCanvas && welcomeEl && welcomeEl.style.display !== 'none') {
        var ww = welcomeCanvas.width / (window.devicePixelRatio || 1);
        var wh = welcomeCanvas.height / (window.devicePixelRatio || 1);
        welcomeCtx.clearRect(0, 0, ww, wh);
        drawRing(welcomeCtx, ww / 2, wh / 2, 40, 2.5);
      }

      animFrame = requestAnimationFrame(loop);
    }

    function setState(s) {
      state = s;
      var wrap = $('gio-avatar-wrap');
      if (wrap) wrap.dataset.state = s;
    }

    function getState() { return state; }

    return { init: init, setState: setState, getState: getState };
  })();


  // ============================================================
  // TOGGLE WINDOW
  // ============================================================
  function toggle() {
    var w = $('gio-chat-window');
    if (!w.classList.contains('gio-open')) {
      w.classList.add('gio-open');
      requestAnimationFrame(function() {
        requestAnimationFrame(function() { w.classList.add('gio-visible'); });
      });
      AvatarRing.init();
      $('gio-input').focus();
    } else {
      w.classList.remove('gio-visible');
      setTimeout(function() { w.classList.remove('gio-open'); }, 300);
    }
  }

  // ============================================================
  // SOUND TOGGLE
  // ============================================================
  function toggleSound() {
    SOUND_ON = !SOUND_ON;
    var btn = $('gio-sound-btn');
    btn.innerHTML = SOUND_ON ? '&#x1f50a;' : '&#x1f507;';
    btn.classList.toggle('gio-sound-active', SOUND_ON);
    if (!SOUND_ON && audio) {
      audio.pause(); audio = null;
      AvatarRing.setState('idle');
      $('gio-status').textContent = 'Online';
    }
  }

  // ============================================================
  // ADD MESSAGE
  // ============================================================
  function addMsg(role, text) {
    if (!started) {
      $('gio-welcome').style.display = 'none';
      $('gio-msgs').style.display = 'flex';
      $('gio-suggestions').style.display = 'none';
      started = true;
    }
    var c = $('gio-msgs');
    var m = document.createElement('div');
    m.className = 'gio-msg ' + (role === 'user' ? 'gio-msg-user' : 'gio-msg-ai');
    var t = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    m.innerHTML = '<div class="gio-bubble">' + escHtml(text) + '</div>' +
                  '<div class="gio-meta">' + (role === 'user' ? 'You' : 'AI Gio') + ' &middot; ' + t + '</div>';
    c.appendChild(m);
    c.scrollTop = c.scrollHeight;
    messages.push({ role: role === 'user' ? 'user' : 'assistant', content: text });
  }

  function showTyping() {
    var c = $('gio-msgs');
    var d = document.createElement('div');
    d.className = 'gio-typing'; d.id = 'gio-typing';
    d.innerHTML = '<span></span><span></span><span></span>';
    c.appendChild(d);
    c.scrollTop = c.scrollHeight;
    $('gio-status').textContent = 'Thinking...';
    AvatarRing.setState('thinking');
  }

  function hideTyping() {
    var t = $('gio-typing'); if (t) t.remove();
    $('gio-status').textContent = 'Online';
    AvatarRing.setState('idle');
  }

  // ============================================================
  // CHAT API (via Vercel proxy)
  // ============================================================
  async function callChat(text) {
    try {
      var res = await fetch(API_BASE + '/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: messages })
      });
      if (!res.ok) throw new Error('API ' + res.status);
      var data = await res.json();
      return data.text || fallback(text);
    } catch (err) {
      console.error('Chat error:', err);
      return fallback(text);
    }
  }

  // ============================================================
  // TTS + WEB AUDIO API (audio-reactive avatar)
  // ============================================================
  async function speak(text) {
    if (!SOUND_ON) return;
    try {
      AvatarRing.setState('speaking');
      $('gio-status').textContent = 'Speaking...';

      var res = await fetch(API_BASE + '/api/tts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: text })
      });
      if (!res.ok) throw new Error('TTS ' + res.status);

      var blob = await res.blob();
      var url = URL.createObjectURL(blob);
      audio = new Audio(url);
      audio.crossOrigin = 'anonymous';

      // Connect to Web Audio API for frequency analysis
      try {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
          await audioCtx.resume();
        }
        audioSource = audioCtx.createMediaElementSource(audio);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 128;
        analyser.smoothingTimeConstant = 0.75;
        freqData = new Uint8Array(analyser.frequencyBinCount);
        audioSource.connect(analyser);
        analyser.connect(audioCtx.destination);
      } catch (webAudioErr) {
        // Web Audio API not available or already connected — fallback to simulated waveform
        console.warn('Web Audio API unavailable, using simulated waveform:', webAudioErr);
        analyser = null;
        freqData = null;
      }

      audio.onended = function() {
        AvatarRing.setState('idle');
        $('gio-status').textContent = 'Online';
        URL.revokeObjectURL(url);
        audio = null;
        audioSource = null;
      };
      audio.onerror = function() {
        AvatarRing.setState('idle');
        $('gio-status').textContent = 'Online';
        audio = null;
        audioSource = null;
      };

      audio.play();
    } catch (err) {
      console.error('TTS error:', err);
      AvatarRing.setState('idle');
      $('gio-status').textContent = 'Online';
    }
  }

  // ============================================================
  // FALLBACK RESPONSES
  // ============================================================
  function fallback(input) {
    var q = input.toLowerCase();
    if (q.includes('cbix') || q.includes('cbi'))
      return "CBIx is CBI's independent innovation subsidiary that I co-founded. We explore AI, tokenized assets, Web3, gaming, and next-gen banking models. Think of it as a startup inside a bank \u2014 but with the freedom to actually ship things.";
    if (q.includes('tokeniz') || q.includes('rwa'))
      return "Tokenized assets are the bridge between TradFi and DeFi that actually makes sense. We're talking about putting real-world assets on-chain for better liquidity, transparency, and accessibility. I'm very bullish on RWAs, provided we fix liquidity issues and secondary trading. Tokenizing an illiquid asset doesnt make it liquid by defaukt.";
    if (q.includes('nft') || q.includes('collect'))
      return "I collect across chains \u2014 Bitcoin Ordinals, Ethereum, Solana. BAYC, Doodles, SMB, NodeMonkes, and incredible 1/1 pieces by Tony Tafuro and No Legs. Each piece represents a different identity or community.";
    if (q.includes('keynote') || q.includes('speak') || q.includes('book'))
      return "I'd love to chat about speaking opportunities! Best way to reach out is through the WhatsApp link on this site \u2014 my team will get back to you quickly.";
    if (q.includes('defi') || q.includes('crypto') || q.includes('web3'))
      return "I'm a closeted DeFi maxi in a banker's suit \u2014 that's the honest truth. BTC and SOL maxi, terrible trader, great culture navigator. The Web3 communities I'm part of are some of the most authentic relationships I have.";
    return "Great question! I'm AI Gio \u2014 an experimental prototype. For the full answer, reach out to the real Gio via WhatsApp or LinkedIn. What else can I help with?";
  }

  // ============================================================
  // SEND MESSAGE
  // ============================================================
  async function send() {
    if (processing) return;
    var input = $('gio-input');
    var text = input.value.trim();
    if (!text) return;
    input.value = '';
    processing = true;
    $('gio-send').disabled = true;

    addMsg('user', text);
    showTyping();

    try {
      var resp = await callChat(text);
      hideTyping();
      addMsg('ai', resp);
      speak(resp);
    } catch (e) {
      hideTyping();
      addMsg('ai', "Something went wrong \u2014 try again in a moment!");
    }
    processing = false;
    $('gio-send').disabled = false;
    $('gio-input').focus();
  }

  function askChip(btn) {
    $('gio-input').value = btn.textContent;
    send();
  }

  return { toggle: toggle, toggleSound: toggleSound, send: send, askChip: askChip };
})();
</script>
